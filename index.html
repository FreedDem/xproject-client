<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XProject</title>

    <!-- ====== BOOTLOADER: тайм-аут + фоллбек на прокси ====== -->
    <script>
      (function () {
        // Настройки
        const PRIMARY_ORIGIN = 'https://<your-app>.vercel.app'; // ⬅️ укажи дом фронта на Vercel
        const PROXY_PREFIX   = '/client-proxy';                 // как на сервере
        const STALL_MS       = 2500;                            // через сколько "рубить" зависшую загрузку

        // Перевод origin-URL -> proxy-URL
        function toProxy(url) {
          try {
            const u = new URL(url, location.href);
            if (!PRIMARY_ORIGIN) return url;
            if (u.origin === PRIMARY_ORIGIN || u.origin === location.origin) {
              // те же путь и query, но через прокси
              return PROXY_PREFIX + u.pathname + u.search;
            }
            return url;
          } catch {
            return url;
          }
        }

        // --- Перехват динамически добавляемых <script> и <link rel="stylesheet">
        const origAppend = Element.prototype.appendChild;
        Element.prototype.appendChild = function (node) {
          // <script src=...>
          if (node && node.tagName === 'SCRIPT' && node.src) {
            const src = node.src;
            let done = false;
            const t = setTimeout(() => {
              if (done) return;
              done = true;
              try { node.remove(); } catch {}
              const s2 = document.createElement('script');
              s2.async = node.async ?? true;
              s2.type = node.type || 'text/javascript';
              s2.crossOrigin = node.crossOrigin || '';
              s2.referrerPolicy = node.referrerPolicy || '';
              s2.src = toProxy(src);
              origAppend.call(this, s2);
            }, STALL_MS);

            node.addEventListener('load', () => { done = true; clearTimeout(t); }, { once: true });
            node.addEventListener('error', () => {
              if (done) return;
              done = true; clearTimeout(t);
              try { node.remove(); } catch {}
              const s2 = document.createElement('script');
              s2.async = node.async ?? true;
              s2.type = node.type || 'text/javascript';
              s2.crossOrigin = node.crossOrigin || '';
              s2.referrerPolicy = node.referrerPolicy || '';
              s2.src = toProxy(src);
              origAppend.call(this, s2);
            }, { once: true });
          }

          // <link rel="stylesheet" href=...>
          if (node && node.tagName === 'LINK' && node.rel === 'stylesheet' && node.href) {
            const href = node.href;
            let done = false;
            const t = setTimeout(() => {
              if (done) return;
              done = true;
              const alt = document.createElement('link');
              alt.rel = 'stylesheet';
              alt.href = toProxy(href);
              try { node.remove(); } catch {}
              return origAppend.call(this, alt);
            }, STALL_MS);

            node.addEventListener('load', () => { done = true; clearTimeout(t); }, { once: true });
            node.addEventListener('error', () => {
              if (done) return;
              done = true; clearTimeout(t);
              const alt = document.createElement('link');
              alt.rel = 'stylesheet';
              alt.href = toProxy(href);
              try { node.remove(); } catch {}
              return origAppend.call(this, alt);
            }, { once: true });
          }

          return origAppend.call(this, node);
        };

        // --- Лёгкий overlay, если приложение долго не монтируется
        const overlay = document.createElement('div');
        overlay.id = 'boot-overlay';
        overlay.style.cssText =
          'position:fixed;inset:0;display:none;align-items:center;justify-content:center;' +
          'font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;' +
          'background:#0b0b0c;color:#c9c9cf;z-index:99999;text-align:center;padding:24px;';
        overlay.innerHTML =
          '<div>' +
          '<div style="font-size:18px;margin-bottom:8px">Загружаем приложение…</div>' +
          '<div style="opacity:.8">Если загрузка зависла, попробуйте резервный канал.</div>' +
          '<div style="margin-top:16px"><button id="boot-btn" style="padding:8px 14px;border-radius:8px;border:1px solid #3a3a3f;background:#1a1a1e;color:#eaeaf0;cursor:pointer">Переключиться на прокси</button></div>' +
          '</div>';
        document.addEventListener('DOMContentLoaded', () => {
          document.body.appendChild(overlay);
          // Покажем через 2.5с, если приложение не смонтировалось
          setTimeout(() => {
            const root = document.getElementById('root');
            if (root && root.childElementCount === 0) {
              overlay.style.display = 'flex';
            }
          }, STALL_MS);
        });
        document.addEventListener('click', (e) => {
          if (e.target && e.target.id === 'boot-btn') {
            // Принудительный режим: все будущие ассеты — через прокси
            window.__FORCE_PROXY__ = true;
            // Обновим страницу, чтобы стартовый бандл тоже пошёл через прокси (см. ниже хук baseURL)
            location.reload();
          }
        });

        // --- Хук <base> для принудительного режима (после reload)
        (function applyForceProxyBase() {
          if (!window.__FORCE_PROXY__ && !/forceProxy=1/.test(location.search)) return;
          try {
            const base = document.createElement('base');
            base.href = PROXY_PREFIX + '/';
            document.head.appendChild(base);
          } catch {}
        })();

        // Сделаем toProxy доступным глобально (если нужно в других местах)
        window.__ASSET_TO_PROXY__ = toProxy;
        window.__PRIMARY_ORIGIN__ = PRIMARY_ORIGIN;
        window.__PROXY_PREFIX__ = PROXY_PREFIX;
      })();
    </script>
    <!-- ====== /BOOTLOADER ====== -->
  </head>
  <body>
    <div id="root"></div>

    <!-- Твой стандартный Vite-скрипт. В dev он /src/main.jsx,
         в prod Vite перепишет на /assets/*.js.
         Наш перехватчик будет работать для всех динамических чанков. -->
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
